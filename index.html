<!DOCTYPE html>
<html>
<head>
    <title>Multimouse</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
<script>
(() => {

const pingIntervalTime = 30 * 1000; // ms

const loc = window.location;
const scheme = loc.protocol === 'https:' ? 'wss :' : 'ws:';

let lastPingTimestamp = Date.now();
let pingInterval;
let reconnecting;

const ws = new WebSocket(`${scheme}//${loc.host}/ws`);

var cursors = {};
var lastReceived = {};

function createUUID() {
    // http://www.ietf.org/rfc/rfc4122.txt
    var s = [];
    var hexDigits = "0123456789abcdef";
    for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
    }
    s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
    s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
    s[8] = s[13] = s[18] = s[23] = "-";

    var uuid = s.join("");
    return uuid;
}

function registerWebsocketHandlers(ws) {
    ws.onmessage = (event) => {

        // check if message is a ping
        if(event.data.startsWith('ping')) {
            lastPingTimestamp = Date.now();
            return;
        }

        var data = JSON.parse(event.data);

        // Convert the scaled coordinates back to pixel coordinates
        var x = data.x * window.innerWidth;
        var y = data.y * window.innerHeight;

        if(data.clientId != clientId) {
            if (!cursors[data.clientId]) {
                var hueRotation = Math.floor(Math.random() * 360);

                var img = document.createElement('img');
                img.src = 'cursor.png';  // Path to the cursor image
                img.style.position = 'absolute';
                img.style.filter = 'hue-rotate(' + hueRotation + 'deg)';
                img.style.opacity = '0';  // Initially hidden
                img.style.transition = 'opacity 1s';
                img.style.transition = 'transform 500ms';

                document.body.appendChild(img);
                cursors[data.clientId] = img;

                // Fade in the cursor
                setTimeout(function() {
                    img.style.opacity = '1';
                }, 0);
            }

            // Update the position of the image element
            var cursor = cursors[data.clientId];
            cursor.style.left = x + 'px';
            cursor.style.top = y + 'px';

            // Update the last received time for this client
            lastReceived[data.clientId] = Date.now();
        }
    };

    ws.onclose = function(event) {
        console.info('Socket is closed. Reconnecting in 1 second');

        if(reconnecting) return;
        reconnecting = true;

        // fast reconnect
        setTimeout(() => {
            clearInterval(pingInterval);
            connect();
            reconnecting = false;
        }, 1000);
    };

    ws.onerror = function(err) {
        console.error(`Socket error: ${err.message}, Closing socket`);
        ws.close();
    };

    ws.onopen = function() {
        console.info('Socket connected');
    };
}

// Periodically check for inactive clients
setInterval(function() {
    var now = Date.now();
    for (var clientId in lastReceived) {
        // If more than a minute has passed since the last time we received data from this client
        if (now - lastReceived[clientId] > 2000) {
            // Fade out the cursor of this client
            var cursor = cursors[clientId];
            cursor.style.transition = 'opacity 1s';
            cursor.style.opacity = '0';

            // Remove the cursor after the transition is complete
            setTimeout(function() {
                cursor.parentNode.removeChild(cursor);
                delete cursors[clientId];
                delete lastReceived[clientId];
            }, 1000);  // The duration of the transition
        }
    }
}, 1000);  // Check every second

// connect to the websocket
function connect() {
    clientId = createUUID();
    console.info('Connecting to websocket');
    registerWebsocketHandlers(ws);

    // periodically check if we have received a ping in the last n seconds
    pingInterval = setInterval(function() {
        if (Date.now() - lastPingTimestamp <= pingIntervalTime) return;

        const seconds = pingInterval / 1000;
        console.info(`No ping received for more than ${seconds} seconds!`);
        lastPingTimestamp = Date.now();
        connect();
    }, pingIntervalTime / 2);
}

function letsGo() {
    console.info('Lets go!');
    const body = document.querySelector('body');
    body.style.cursor = 'none';
}

document.addEventListener('mousemove', (event) => {
    const x = event.clientX / window.innerWidth;
    const y = event.clientY / window.innerHeight;

    // send mouse move event to server
    const msg = JSON.stringify({clientId, x, y});
    console.info(`Sending mouse move event: ${msg}`);
    ws.send(msg);
});


// lets party!
connect();

})();
</script>
</body>
</html>
